<script type="module">
    import { supabase } from "/guard.js"
    
    console.log("Waiting for OAuth session...")
    
    let handled = false
    
    supabase.auth.onAuthStateChange(async (event, session) => {
      console.log("AUTH EVENT:", event, session)
    
      if (handled) return
      if (!session) return
    
      const providerToken = session.provider_token
      const refreshToken = session.provider_refresh_token
    
      // If no provider token, this was just a normal login
      if (!providerToken) {
        console.log("No Google tokens in this session")
        window.location.replace("/activate.html")
        return
      }
    
      handled = true
    
      console.log("Saving Google connection...")
    
      await supabase.from("google_connections").upsert({
        user_id: session.user.id,
        access_token: providerToken,
        refresh_token: refreshToken
      })
    
      console.log("Saved âœ”")
    
      // clean URL (remove #access_token fragment)
      history.replaceState({}, document.title, "/connected.html")
    
      window.location.replace("/connected.html")
    })
    </script>